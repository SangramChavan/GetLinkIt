// Main function to handle incoming Telegram messages
function doPost(e) {
  var contents = JSON.parse(e.postData.contents);
  var message = contents.message.text;
  var chatId = contents.message.chat.id;
  
  // Check if the message is an order
  if (message.startsWith("/order")) {
    var orderDetails = message.replace("/order", "").trim();
    saveOrderToSheet(orderDetails, chatId);
    sendMessage(chatId, "Thank you! Your order has been recorded.");
  }
  else if (message.startsWith("/check")) {
    checkOrderStatus(chatId);
  }
}

// Function to send a message back to the Telegram user
function sendMessage(chatId, text) {
  var url = "https://api.telegram.org/bot7769555938:AAFLfTsgsgIBy87pK2vtPR7dRnChQyaXefY/sendMessage";
  var data = {
    "chat_id": chatId,
    "text": text
  };
  
  var options = {
    "method": "post",
    "payload": JSON.stringify(data),
    "contentType": "application/json"
  };
  
  UrlFetchApp.fetch(url, options);
}

// Function to save order details in Google Sheets
function saveOrderToSheet(orderDetails, chatId) {
  var sheet = SpreadsheetApp.openById("1022732537").getSheetByName("Orders");
  
  // Assuming orderDetails contains product and quantity, separated by a comma
  var details = orderDetails.split(",");
  var productName = details[0].trim();
  var quantity = details[1].trim();

  // Append the order details to the sheet
  sheet.appendRow([new Date(), chatId, productName, quantity, "Pending"]);
}

// Function to check the order status by Chat ID
function checkOrderStatus(chatId) {
  var sheet = SpreadsheetApp.openById("1022732537").getSheetByName("Orders");
  var data = sheet.getDataRange().getValues();
  var foundOrder = false;
  
  for (var i = 1; i < data.length; i++) { // Start from 1 to skip headers
    if (data[i][1] == chatId) {  // Column B: Chat ID
      sendMessage(chatId, `Your order of ${data[i][2]} (Qty: ${data[i][3]}) is currently: ${data[i][4]}`); // Product, Quantity, Status
      foundOrder = true;
      break;
    }
  }
  
  if (!foundOrder) {
    sendMessage(chatId, "No orders found for your ID.");
  }
}
